(()=>{"use strict";var e={68:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),s(142).config();const n=S(s(860)),a=s(685),_=s(952),o=S(s(582)),r=S(s(185)),c=S(s(515)),u=S(s(844)),i=S(s(119)),T=S(s(761)),E=s(289),d=(0,n.default)(),A=(0,a.createServer)(d),l=new _.Server(A,{cors:E.corsConfig}),O=process.env.LOCAL_HOST,C=process.env.SERVER_HOST,f=process.env.PORT,U=process.env.DB_CONNECT_LINK,D=process.env.ROOT_URL,p=process.env.ENVIRONMENT;d.use((0,o.default)()),d.use(n.default.json()),d.use(`${D}/healthCheck`,i.default),d.use(D,T.default),r.default.connect(U).then((async()=>{A.listen(f,(async()=>{c.default.info("Database has been connected"),c.default.info(`ðŸš€ Server is running on ${p} ðŸš€ - http://${"PRODUCTION"===p.toUpperCase()?C:O}:${f}${D}`),u.default.verifyUser({io:l})}))})).catch((e=>{c.default.error("Can't connect to database"),c.default.error(`Error: ${e}`),process.exit()}))},398:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.healthCheck=t.asyncMap=t.sortStringArray=t.isEmpty=void 0,t.isEmpty=e=>e instanceof Array?0===e.length:null==e||0===Object.keys(e).length,t.sortStringArray=e=>e.sort((function(e,t){return e<t?-1:e>t?1:0})),t.asyncMap=async(e,t)=>Promise.all(e.map((async e=>await t(e))));const s={uptime:process.uptime(),message:"OK",timestamp:Date.now()};t.healthCheck=s},289:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.corsConfig=t.EVENTS=void 0,t.EVENTS={connection:"connection",CLIENT:{CREATE_ROOM:"CREATE_ROOM",SEND_ROOM_MESSAGE:"SEND_ROOM_MESSAGE",JOIN_ROOM:"JOIN_ROOM",GET_CONTACT_LIST:"GET_CONTACT_LIST",ADD_NEW_CONTACT:"ADD_NEW_CONTACT"},SERVER:{ROOMS:"ROOMS",JOINED_ROOM:"JOINED_ROOM",ROOM_MESSAGE:"ROOM_MESSAGE",GET_CONTACT_LIST:"GET_CONTACT_LIST",SEND_NEW_CONTACT_SENDER:"SEND_NEW_CONTACT_SENDER",CREATED_AND_JOIN_ROOM:"CREATED_AND_JOIN_ROOM",SEND_MESSAGE:{UPDATE_SENDER_MESSAGE:"UPDATE_SENDER_MESSAGE",UPDATE_MESSAGE_EXPECT_SENDER:"UPDATE_MESSAGE_EXPECT_SENDER"},STATUS:{ONLINE:"ONLINE",OFFLINE:"OFFLINE"}}},t.corsConfig={origin:"http://localhost:5173",credentials:!0}},447:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),s(142).config();const n=S(s(344)),a=S(s(762)),_=s(160),o=S(s(191));t.default=class{static async signToken(e,t){try{const s=e.query,S=await a.default.checkAcceptChat(s);if(S.statusCode===_.STATUS_CODE.STATUS_CODE_200){const e=process.env.JWT_TOKEN_SECRET_KEY,S=process.env.TOKEN_EXPIRES_IN,a=n.default.sign(s,e,{expiresIn:S});t.status(_.STATUS_CODE.STATUS_CODE_200).send(o.default.onSuccess(_.STATUS_CODE.STATUS_CODE_200,_.STATUS_MESSAGE.SUCCESS,{access_token:a,expiresIn:S,userAuthData:s}))}else t.status(S.statusCode).send(S)}catch(e){console.log(e),t.status(_.STATUS_CODE.STATUS_CODE_500).send(o.default.onSuccess(_.STATUS_CODE.STATUS_CODE_500,_.STATUS_MESSAGE.SERVER_ERROR))}}}},277:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(398),a=s(603),_=S(s(762)),o=s(160),r=S(s(191));t.default=class{static async getConversationByMembers(e,t){try{const{members:s}=e.body,S=await a.Conversation.findOne({members:{$elemMatch:s[0]&&s[1]}});S?t.status(o.STATUS_CODE.STATUS_CODE_200).send(r.default.onSuccess(o.STATUS_CODE.STATUS_CODE_200,o.STATUS_MESSAGE.SUCCESS,S)):t.status(o.STATUS_CODE.STATUS_CODE_404).send(r.default.onSuccess(o.STATUS_CODE.STATUS_CODE_404,o.STATUS_MESSAGE.NOT_FOUND,"They haven't been chat before!"))}catch(e){const s=e;t.status(o.STATUS_CODE.STATUS_CODE_500).send(r.default.onFail(o.STATUS_CODE.STATUS_CODE_500,s))}}static async getContactList(e,t,s){try{const s=e.query.id,S=e.query.type,c=await a.Conversation.find({members:{$elemMatch:{id:s,type:S}}}),u=async t=>{const s=t.filter((t=>{var s;const S=null===(s=e.query.id)||void 0===s?void 0:s.toString();return t.id.toString()!==S.toString()})).reduce(((e,t)=>{const s=t.type,S=+t.id;return e.ids[s].push(S),e}),{ids:{student:[],admissions_officer:[],admin:[]}}),{data:S}=await _.default.searchListUser(s);return S};t.status(o.STATUS_CODE.STATUS_CODE_200).send(r.default.onSuccess(o.STATUS_CODE.STATUS_CODE_200,o.STATUS_MESSAGE.SUCCESS,await(0,n.asyncMap)(c,(async e=>{const{id:t,members:s,messages:S}=e;return{conversationID:t,members:await u(s),messages:S}}))))}catch(e){s(e)}}}},170:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=S(s(185)),a=s(398),_=s(160),o=S(s(191));t.default=class{static async checkScreen(e,t){try{t.status(_.STATUS_CODE.STATUS_CODE_200).send(o.default.onSuccess(_.STATUS_CODE.STATUS_CODE_200,_.STATUS_MESSAGE.SUCCESS,a.healthCheck))}catch(e){a.healthCheck.message=e,t.status(_.STATUS_CODE.STATUS_CODE_503).end(o.default.onSuccess(_.STATUS_CODE.STATUS_CODE_503,_.STATUS_MESSAGE.SERVICES_UNAVAILABLE,a.healthCheck))}}static async checkDatabase(e,t){const s=n.default.model("HealthCheck",new n.default.Schema({event:String},{collection:"HealthCheck",minimize:!1}));async function S(){return await s.findOneAndUpdate({event:"check"},{event:"check"},{new:!0,upsert:!0})}try{void 0!==await S()?t.status(_.STATUS_CODE.STATUS_CODE_200).send(o.default.onSuccess(_.STATUS_CODE.STATUS_CODE_200,_.STATUS_MESSAGE.SUCCESS,await S())):t.status(_.STATUS_CODE.STATUS_CODE_503).end(o.default.onSuccess(_.STATUS_CODE.STATUS_CODE_503,_.STATUS_MESSAGE.SERVICES_UNAVAILABLE))}catch(e){t.status(_.STATUS_CODE.STATUS_CODE_503).end(o.default.onSuccess(_.STATUS_CODE.STATUS_CODE_503,_.STATUS_MESSAGE.SERVICES_UNAVAILABLE))}}}},456:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=S(s(185)),a=new n.default.Schema({id:{type:String},name:{type:String},members:{type:[{id:{type:String},type:{type:String}}]},messages:{type:[{sender:{id:{type:String},type:{type:String}},content:{type:String},createdAt:{type:Date},updatedAt:{type:Date}}]},createdAt:{type:Date},updatedAt:{type:Date}},{timestamps:!0,minimize:!1}),_=n.default.model("Conversation",a);t.default=_},535:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=S(s(185)),a=new n.default.Schema({db_id:{type:String},chat_id:{type:String},type:{type:String},contactList:{type:[{type:String}]},status:{type:String,default:"offline"}},{timestamps:!0,minimize:!1}),_=n.default.model("User",a);t.default=_},603:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.User=t.Conversation=void 0;const n=S(s(456));t.Conversation=n.default;const a=S(s(535));t.User=a.default},199:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(860),a=S(s(447)),_=(0,n.Router)();_.get("/get-token",a.default.signToken),t.default=_},382:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(860),a=S(s(277)),_=(0,n.Router)();_.post("/get-by-members",a.default.getConversationByMembers).get("/contact",a.default.getContactList),t.default=_},119:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(860),a=S(s(170)),_=(0,n.Router)();_.get("/screen",a.default.checkScreen).get("/database",a.default.checkDatabase),t.default=_},761:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(860),a=S(s(199)),_=S(s(382)),o=(0,n.Router)();o.use("/conversation",_.default),o.use("/auth",a.default),t.default=o},844:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),s(142).config();const n=S(s(344)),a=S(s(817));t.default=class{static verifyUser({io:e}){e.use(((e,t)=>{try{const{token:s}=e.handshake.query,S=n.default.verify(s,process.env.JWT_TOKEN_SECRET_KEY);e.decode={...S,isAuth:!1},t()}catch(s){const{message:S}=s;e.decode={message:S,isAuth:!1},t()}})),a.default.onAuthenticate({io:e})}}},817:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=s(828),a=s(603),_=s(289),o=S(s(515)),r=S(s(191)),c=s(160);t.default=class{static onAuthenticate({io:e}){e.on(_.EVENTS.connection,(t=>{var s;(null===(s=t.decode)||void 0===s?void 0:s.isAuth)?(o.default.info({status:r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_200,c.STATUS_MESSAGE.SUCCESS,{message:`User has authenticate: ${t.id}`})}),t.emit("authenticate",r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_200,c.STATUS_MESSAGE.SUCCESS)),t.on(_.EVENTS.CLIENT.CREATE_ROOM,(({members:s,message:S})=>{(async()=>{const o={id:(0,n.v4)(),members:s.map((e=>({id:e.id,type:e.type}))),messages:[{sender:{id:S.sender.id.toString(),type:S.sender.type},content:S.content,createdAt:new Date,updatedAt:new Date}]},u=await a.Conversation.create(o);t.join(o.id),e.emit(_.EVENTS.SERVER.CREATED_AND_JOIN_ROOM,r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_200,c.STATUS_MESSAGE.SUCCESS,{conversation_id:u.id,members:u.members,messages:u.messages}))})()})),t.on(_.EVENTS.CLIENT.SEND_ROOM_MESSAGE,(e=>{const s={...e.message,createdAt:new Date};(async()=>{await a.Conversation.findOneAndUpdate({id:e.conversationID},{$push:{messages:s}});const S=await a.Conversation.findOne({id:e.conversationID});t.emit(_.EVENTS.SERVER.SEND_MESSAGE.UPDATE_SENDER_MESSAGE,r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_200,c.STATUS_MESSAGE.SUCCESS,S)),t.to(e.conversationID).emit(_.EVENTS.SERVER.SEND_MESSAGE.UPDATE_MESSAGE_EXPECT_SENDER,r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_200,c.STATUS_MESSAGE.SUCCESS,{conversation_id:S.id,messages:S.messages}))})()})),t.on(_.EVENTS.CLIENT.JOIN_ROOM,(e=>{t.join(e),t.emit(_.EVENTS.SERVER.JOINED_ROOM,r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_200,c.STATUS_MESSAGE.SUCCESS,{roomId:e}))}))):(o.default.info({status:r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_401,c.STATUS_MESSAGE.UN_AUTHORIZE)}),t.emit("unAuthenticate",r.default.onSuccess(c.STATUS_CODE.STATUS_CODE_401,c.STATUS_MESSAGE.UN_AUTHORIZE)))}))}}},762:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),s(142).config();const n=s(160),a=S(s(717)),_=S(s(191)),o=s(729);class r{static async getAccessToken(){try{const e=new FormData;return e.append("email",process.env.ADMIN_EMAIL),e.append("password",process.env.ADMIN_PASSWORD),(await a.default.createInstance(n.API_STUFF.uniberty_baseURL).post(n.API_PATH.admin_login,e)).data.access_token}catch(e){return}}static async searchListUser(e){try{const t={};return await a.default.createInstance(n.API_STUFF.uniberty_baseURL).post(n.API_PATH.search_list_user,e,{headers:{Authorization:`Bearer ${n.API_STUFF.token}`}}).then((e=>{Object.assign(t,{status:n.API_RESPONSE_STATUS.SUCCESS,data:e.data})})),t}catch(e){const t=e;return{status:n.API_RESPONSE_STATUS.SUCCESS,message:t}}}static async checkAcceptChat(e){try{const{type:t}=e;switch(t){case o.USER_ROLE.STUDENT:{const{id:t}=e,s=await r.getAccessToken();return(await a.default.createInstance(n.API_STUFF.uniberty_baseURL).get(`${n.API_PATH.student_login}/${t}`,{headers:{Authorization:`Bearer ${s}`}})).status===n.STATUS_CODE.STATUS_CODE_200?_.default.onSuccess(n.STATUS_CODE.STATUS_CODE_200,n.STATUS_MESSAGE.SUCCESS):_.default.onSuccess(n.STATUS_CODE.STATUS_CODE_406,n.STATUS_MESSAGE.NOT_ACCEPTABLE)}case o.USER_ROLE.ADMIN:{const{access_token:t}=e;return(await a.default.createInstance(n.API_STUFF.uniberty_baseURL).get(n.API_PATH.admin_me,{headers:{Authorization:`Bearer ${t}`}})).status===n.STATUS_CODE.STATUS_CODE_200?_.default.onSuccess(n.STATUS_CODE.STATUS_CODE_200,n.STATUS_MESSAGE.SUCCESS):_.default.onSuccess(n.STATUS_CODE.STATUS_CODE_406,n.STATUS_MESSAGE.NOT_ACCEPTABLE)}default:return _.default.onSuccess(n.STATUS_CODE.STATUS_CODE_406,`User type: "${t}" in-correct`)}}catch(e){const t={message:n.STATUS_MESSAGE.NOT_ACCEPTABLE};return _.default.onFail(n.STATUS_CODE.STATUS_CODE_406,t)}}}t.default=r},160:(e,t)=>{var s,S,n,a,_;Object.defineProperty(t,"__esModule",{value:!0}),t.API_PATH=t.API_RESPONSE_STATUS=t.API_STUFF=t.STATUS_CODE=t.STATUS_MESSAGE=void 0,function(e){e.uniberty_baseURL="http://103.57.223.118:8888",e.token="5cc085cf-0c55-4102-ae86-1456d613aa21"}(s||(s={})),t.API_STUFF=s,function(e){e.SUCCESS="Success",e.FAIL="Fail"}(S||(S={})),t.API_RESPONSE_STATUS=S,function(e){e.admin_me="/api/admin/me",e.admin_login="/api/admin/login",e.student_login="/api/admin/student",e.search_list_user="/api/admin/search-list-user"}(n||(n={})),t.API_PATH=n,function(e){e.SUCCESS="Success",e.CONFLICT="Conflict",e.NOT_FOUND="Not Found",e.SERVER_ERROR="Server Error",e.NO_CONTENT="No Content",e.UN_AUTHORIZE="Unauthorize",e.NOT_ACCEPTABLE="Not Acceptable",e.SERVICES_UNAVAILABLE="Services Unavailable"}(a||(a={})),t.STATUS_MESSAGE=a,function(e){e[e.STATUS_CODE_200=200]="STATUS_CODE_200",e[e.STATUS_CODE_201=201]="STATUS_CODE_201",e[e.STATUS_CODE_202=202]="STATUS_CODE_202",e[e.STATUS_CODE_204=204]="STATUS_CODE_204",e[e.STATUS_CODE_401=401]="STATUS_CODE_401",e[e.STATUS_CODE_404=404]="STATUS_CODE_404",e[e.STATUS_CODE_406=406]="STATUS_CODE_406",e[e.STATUS_CODE_409=409]="STATUS_CODE_409",e[e.STATUS_CODE_500=500]="STATUS_CODE_500",e[e.STATUS_CODE_503=503]="STATUS_CODE_503"}(_||(_={})),t.STATUS_CODE=_},729:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.USER_ROLE=void 0,function(e){e.ADMISSIONS_OFFICER="admissions_officer",e.STUDENT="student",e.ADMIN="admin"}(s||(s={})),t.USER_ROLE=s},717:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=S(s(167)),a=s(160);class _{static createInstance(e){return n.default.create({baseURL:e||_.URL})}}_.URL=a.API_STUFF.uniberty_baseURL,_.token=a.API_STUFF.token,_.message="",t.default=_},191:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const S=s(160);t.default=class{constructor(){this.data={},this.message="",this.statusCode=S.STATUS_CODE.STATUS_CODE_200}static onSuccess(e,t,s){return{statusCode:e,message:t,data:s}}static onFail(e,t){return{statusCode:e,error:t}}}},515:function(e,t,s){var S=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=S(s(545)),a=S(s(635)),_=(0,n.default)({prettyPrint:!0,base:{pid:!1},timestamp:()=>`,"time":"${(0,a.default)().format()}"`});t.default=_},167:e=>{e.exports=require("axios")},582:e=>{e.exports=require("cors")},635:e=>{e.exports=require("dayjs")},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},344:e=>{e.exports=require("jsonwebtoken")},185:e=>{e.exports=require("mongoose")},545:e=>{e.exports=require("pino")},952:e=>{e.exports=require("socket.io")},828:e=>{e.exports=require("uuid")},685:e=>{e.exports=require("http")}},t={};!function s(S){var n=t[S];if(void 0!==n)return n.exports;var a=t[S]={exports:{}};return e[S].call(a.exports,a,a.exports,s),a.exports}(68)})();